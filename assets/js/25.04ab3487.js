(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{437:function(t,a,s){"use strict";s.r(a);var n=s(2),r=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),a("p",[t._v("渲染流水线中的CSS样式计算的子阶段是非常重要的，决定了页面最终展示的效果，影响到用户体验。")]),t._v(" "),a("h2",{attrs:{id:"渲染流程-html-css-外部引用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#渲染流程-html-css-外部引用"}},[t._v("#")]),t._v(" 渲染流程 => HTML + CSS（外部引用）")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://s2.loli.net/2022/09/29/KnudzTtSg9f4cE8.png",alt:"CSS渲染流程.png"}}),t._v("\n渲染进程（or 浏览器进程）发起数据请求，该请求会通知网络进程去处理，网络进程请求后接受返回的HTML数据，将其发送给渲染进程，渲染进程开始解析HTML文件字节流，构建DOM树。")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[a("strong",[t._v("请求HTML数据和构建DOM树之间会有一段空闲时间，这有可能成为页面渲染的瓶颈。")])])]),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("html")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("head")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("link")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("href")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("test.css"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("rel")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("stylesheet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("head")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("body")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("test"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("body")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("html")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("div",{staticClass:"language-css line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-css"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* test.css */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token selector"}},[t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v("background-color")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("black\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("渲染进程在接收到HTML文件字节流的时候，会先开启一个"),a("strong",[t._v("预解析线程")]),t._v("，如果遇到JavaScript文件 or CSS文件，预解析线程会提前进行下载。上述代码中，预解析线程会解析出一个外部的test.css文件并发起下载。这里也会出现一个空闲时间，当DOM树构建结束、test.css文件尚未下载完成的这段时间里，渲染流水线会处于空闲状态，因为下一步阶段是合成布局树，是需要DOM + CSSOM的，所以需要等待CSS下载结束并解析成CSSOM的。")]),t._v(" "),a("h3",{attrs:{id:"关于cssom"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关于cssom"}},[t._v("#")]),t._v(" 关于CSSOM")]),t._v(" "),a("p",[t._v("跟HTML一样，渲染引擎是无法直接理解CSS文件的，需要解析成CSSOM结构才能理解（类似于DOM）。CSSOM在DOM中就是document.styleSheets"),a("br"),t._v(" "),a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Glossary/CSSOM",target:"_blank",rel:"noopener noreferrer"}},[t._v("CSSOM"),a("OutboundLink")],1),t._v("作用：")]),t._v(" "),a("ul",[a("li",[t._v("给JavaScript提供操作样式表的能力")]),t._v(" "),a("li",[t._v("为合成布局树提供基础的样式信息")])]),t._v(" "),a("p",[t._v("DOM + CSSOM => 合成布局树，布局树会复制一份DOM结构，同时会过滤掉不需要显示的元素（display:none、head标签、script标签），然后渲染引擎会根据CSSOM为对应DOM选择样式信息（样式计算）、同时也会计算布局树中DOM元素几何位置（布局计算），"),a("strong",[t._v("样式计算 + 布局计算最终完成布局树构建")]),t._v("，之后就可以进入绘制流程了。")]),t._v(" "),a("h2",{attrs:{id:"渲染流程-html-css-javascript"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#渲染流程-html-css-javascript"}},[t._v("#")]),t._v(" 渲染流程 => HTML + CSS + JavaScript")]),t._v(" "),a("h3",{attrs:{id:"css-标签内部遇到javascript代码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#css-标签内部遇到javascript代码"}},[t._v("#")]),t._v(" CSS + 标签内部遇到JavaScript代码")]),t._v(" "),a("p",[t._v("解析DOM的时候，如果遇到JavaScript脚本，需要暂停DOM解析去执行JavaScript（JavaScript是可能修改当前状态的DOM），执行JavaScript脚本之前，如果页面包含外部CSS文件 or style标签内置CSS内容，渲染引擎需要先把这些内容转为CSSOM，因为JavaScript也是有修改CSSOM的能力的。"),a("br"),t._v("\n所以：")]),t._v(" "),a("ul",[a("li",[t._v("执行JavaScript之前需要依赖CSSOM")]),t._v(" "),a("li",[t._v("CSS部分情况也会阻塞DOM生成\n"),a("img",{attrs:{src:"https://s2.loli.net/2022/09/29/EZ5VNxYOg8DrLtJ.png",alt:"CSS_JS渲染流程.png"}})])]),t._v(" "),a("h3",{attrs:{id:"css-外部引用javascript文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#css-外部引用javascript文件"}},[t._v("#")]),t._v(" CSS + 外部引用JavaScript文件")]),t._v(" "),a("p",[t._v("上面提到渲染进程在接收到HTML的时候，会有预解析的过程，HTML解析器识别到CSS文件和JavaScript文件需要下载，会同时发起两个文件的下载（所以下载时间按照最久的文件来计算）。后续的渲染流程跟上述是一样的，无论CSS文件 or JavaScript文件谁先下载到达，都需要等待CSS文件下载完成且生成CSSOM，才能继续执行JavaScript脚本，最后再继续构建DOM，生成布局树，渲染页面。\n"),a("img",{attrs:{src:"https://s2.loli.net/2022/09/29/RBN53gArMXI2pmJ.png",alt:"CSS_外部JS渲染流程.png"}})]),t._v(" "),a("h2",{attrs:{id:"页面白屏优化策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#页面白屏优化策略"}},[t._v("#")]),t._v(" 页面白屏优化策略")]),t._v(" "),a("p",[t._v("渲染流程的快慢影响到首次页面展示速度，首次页面展示速度影响用户体验。"),a("br"),t._v("\n从发起URL请求 => 首次页面展示，视觉上经历三个阶段。")]),t._v(" "),a("ol",[a("li",[t._v("发送请求到提交数据的阶段，此时页面是老的内容，需要等待提交文档阶段，页面内容才会被替换 => "),a("RouterLink",{attrs:{to:"/frontend/browser/what-happen-input-url.html"}},[t._v("浏览器URL导航")]),a("br"),t._v("\n该阶段瓶颈主要因素是"),a("strong",[t._v("网络 or 服务器处理")]),t._v("。")],1),t._v(" "),a("li",[t._v("提交文档后，渲染进程创建空白页面（解析白屏），等待CSS、JavaScript文件加载完成，生成CSSOM和DOM，合成布局树，首次渲染。"),a("br")]),t._v(" "),a("li",[t._v("首次渲染完成，进入完整的页面生成阶段，页面一点点绘制出来。")])]),t._v(" "),a("h3",{attrs:{id:"第2阶段白屏优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第2阶段白屏优化"}},[t._v("#")]),t._v(" 第2阶段白屏优化")]),t._v(" "),a("p",[t._v("一般情况，这阶段瓶颈主要体现在下载CSS、JavaScript文件、执行JavaScript、合成布局树、绘制页面等一系列流水线阶段。")]),t._v(" "),a("ul",[a("li",[t._v("内联JavaScript、内联CSS避免这两种文件的下载，这样HTML文件可以直接开始渲染流程。")]),t._v(" "),a("li",[t._v("部分场景不适合内联，可以考虑减小文件体积 => Webpack等打包工具移除注释、压缩JS。")]),t._v(" "),a("li",[t._v("无需在解析HTML阶段使用的JavaScript"),a("strong",[t._v("使用async或defer标记异步加载")]),t._v("。")]),t._v(" "),a("li",[t._v("比较大的CSS文件，基于媒体查询属性，将其拆分为多个不同用途的CSS文件，特定的场景 => 加载特定的CSS文件。")])]),t._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("ul",[a("li",[t._v("DOM + CSSOM => 合成布局树，JavaScript同时有能力修改DOM、CSSOM。")]),t._v(" "),a("li",[t._v("执行JavaScript会阻塞HTML解析DOM，JavaScript执行前会依赖CSSOM的存在。")]),t._v(" "),a("li",[t._v("JavaScript和CSS给页面渲染带来了限制。")]),t._v(" "),a("li",[t._v("注意资源加载速度、不同文件之间依赖关系。")])])])}),[],!1,null,null,null);a.default=r.exports}}]);